// released under Open Source GPL License Copyright ¬© 2023 Ka Hei Chow

// ####################################### //
// ######    Map Comparison App     ###### //
// ####################################### //


/**
 * This is a script for comparing layers between national admin regions.
 * 
 * To do: 
 * - <del> add data layer control </del>
 * - add welcome panel with instructions
 * - provide more urban heat relevant layers
 *
 */

// import modules 
var palettes = require('users/gena/packages:palettes');
var analysis = require('users/pinkychow1010/WB_IntraUrban:analysis_utils');
var helper = require('users/pinkychow1010/WB_IntraUrban:helper');
var style = require('users/pinkychow1010/WB_IntraUrban:map_compare_style'); // dict for app styling
var basemap = require('users/pinkychow1010/WB_IntraUrban:basemap_resources'); 

exports.comparison_app = function(layer_dict, info_dict, url_dict) {
  // import project data layers for admin level selections
  var ADM0 = ee.FeatureCollection("projects/sat-io/open-datasets/geoboundaries/CGAZ_ADM0");
  var ADM1 = ee.FeatureCollection("projects/sat-io/open-datasets/geoboundaries/CGAZ_ADM1");
  var ADM2 = ee.FeatureCollection("projects/sat-io/open-datasets/geoboundaries/CGAZ_ADM2");
  
  // customized basemap to enhance visuals 
  var new_basemap = basemap.getCustomBasemap('MutedMonotone');
  
  // set all map controls
  var mapControl = style.mapControl;
  
  // Create two maps with custom options
  // left map
  var map1 = ui.Map();
  map1.style().set('cursor', 'crosshair'); // set cursor shape
  map1.setControlVisibility(mapControl); // hide unnecessary map controls to give space
  
  // right map
  var map2 = ui.Map();
  map2.style().set('cursor', 'crosshair'); // cursor shape
  map2.setControlVisibility(mapControl); // set map control
  map2.setControlVisibility({zoomControl: false}) ;
  
  // customized basemap for both maps to enhance visuals
  map1.setOptions(undefined, {'Custom': new_basemap});
  map2.setOptions(undefined, {'Custom': new_basemap});
  
  // link control between two maps
  var linker = ui.Map.Linker([map1, map2]);
  
  // create a grid of maps
  var mapGrid = ui.Panel(
      [ui.Panel([map1], null, {stretch: 'both'}),
        ui.Panel([map2], null, {stretch: 'both'})],
      ui.Panel.Layout.Flow('horizontal'), {stretch: 'both'}
      );
  
  // main panel on the side for argument selections
  var mainPanel = ui.Panel();
  mainPanel.style().set(style.mainPanel); // define style
  
  // Add the maps and title to the ui.root.
  ui.root.widgets().reset([mainPanel, mapGrid]);
  ui.root.setLayout(ui.Panel.Layout.Flow('horizontal'));
  
  // set up title
  var title = ui.Label("Map Comparison üó∫Ô∏è");
  title.style().set(style.title);
  
  mainPanel.add(title); // add title to main panel
  
  var dropdownPanel = ui.Panel(); // panel to hold the drop-down boxes
  dropdownPanel.style().set(style.dark_theme);
  
  // set up location input session (dropdowns for admin0, admin1 and admin2 names)
  // disable admin selections
  var admin0Select = ui.Select({
      placeholder: 'Please wait..',
    }).setDisabled(true);
  
  dropdownPanel.add(admin0Select); // add country drop down
  
  
  // select variable 1 (left map)
  var var1_selection = ui.Select({
    placeholder: 'Select data layer 1...',
    items: Object.keys(layer_dict),
  });
  
  var var2_selection = ui.Select({
    placeholder: 'Select data layer 2...',
    items: Object.keys(layer_dict),
  });
  
  dropdownPanel.add(var1_selection); 
  dropdownPanel.add(var2_selection); 
  
  // add drop down to side bar
  mainPanel.add(dropdownPanel); // display on main panel
  
  // start computing button to pass arguments to calculation
  var start_button = ui.Button({
    label: "Start Computing",
    onClick: computeMap
  });
  
  start_button.style().set(style.start_button);
  mainPanel.add(start_button);
  
  var loading_button = ui.Label("Please wait...", style.dark_theme);
  loading_button.style().set({color:"white", shown: false});
  // loading_button.setImageUrl("https://i.gifer.com/ZKZg.gif");
  mainPanel.add(loading_button);
  
  var waitPanel = ui.Panel();
  var spinner = "data:image/gif;base64,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";
  // var spinner = "https://media.tenor.com/UnFx-k_lSckAAAAM/amalie-steiness.gif"
  // var spinner = "https://i.gifer.com/origin/34/34338d26023e5515f6cc8969aa027bca_w200.gif";
  var waitMessage = ui.Panel([
  // ui.Label({imageUrl: spinner}),
  ui.Label('Processing takes ~1 min')
  ], ui.Panel.Layout.flow('horizontal'));
  
  // var emptyMessage = ui.Panel([ui.Label('')]);
  // emptyMessage.style().set(style.dark_theme);
  
  mainPanel.add(waitPanel);
  
  // center maps
  map1.setCenter(70,30,5);
  map2.setCenter(70,30,5);
  
  // Update from country selection
  // function after selection: zoom to country; no computation yet
  var admin0Selected = function(admin0Selection) {
    var selectedAdmin0 = ADM0.filter(
      ee.Filter.eq('shapeName', admin0Selection)
      );
    map1.centerObject(selectedAdmin0,5); // zoom to country
  };
  
  admin0Select.onChange(admin0Selected); // set up response for drop down
  
  // Get all country names and sort them
  var admin0Names = ADM0.aggregate_array('shapeName').sort().distinct();
  
  // Fetch the value using evaluate() to not block the UI
  admin0Names.evaluate(function(items){
    admin0Select.items().reset(items);
    admin0Select.setDisabled(false); // enable menu
    admin0Select.setPlaceholder('Select country'); // Change placeholder
  });
  
  // Get value from drop down and use it to compute layers for aoi
  function computeMap(value) {
    
    waitPanel.widgets().reset([waitMessage]);
    loading_button.style().set({shown: true});
    var country_name = admin0Select.getValue(); // get selected country
    map1.clear(); // clear map
    map2.clear();
    
    // customized basemap to enhance visuals
    map1.setOptions(undefined, {'Custom': new_basemap});
    map2.setOptions(undefined, {'Custom': new_basemap});
    
    // add data layer label
    var var1 = var1_selection.getValue();
    var var2 = var2_selection.getValue();
    
    // remove category label if applicable (only name of the dataset)
    var var1_label = var1.replace(/.*(?=\|)/g, '').replace(/[|]/g,"").replace(/^\s/g,"");
    var var2_label = var2.replace(/.*(?=\|)/g, '').replace(/[|]/g,"").replace(/^\s/g,"");
    
    // use layer selection to control displayed labels
    helper.add_popup(var1_label, info_dict[var1], map1, url_dict[var1]);
    helper.add_popup(var2_label, info_dict[var2], map2, url_dict[var2]);
    // map1.add(ui.Label(var1_label, style.map_label));
    // map2.add(ui.Label(var2_label, style.map_label));
    
    // use country name to compute aoi geometry
    var selectedAdmin0 = ADM0.filter(ee.Filter.eq('shapeName', country_name));
    var shapeGroup = ee.Feature(selectedAdmin0.first()).get('shapeGroup');
    
    // get details at the admin 2 level
    var aoi = ADM2.filter(ee.Filter.eq('shapeGroup', shapeGroup));
    
    // ger layer based on user selection, call aoi to get regional raster only
    var layer1 = layer_dict[var1](aoi);
    var layer2 = layer_dict[var2](aoi);
    
    // get choropleth maps for both maps
    helper.zonalInspect(aoi, layer1, map1); // vector, raster, map, reducer, log
    helper.zonalInspect(aoi, layer2, map2); 
    
    // set map control
    map1.setControlVisibility(mapControl);
    map2.setControlVisibility(mapControl);
    map2.setControlVisibility({zoomControl: false});
    
    // disable waiting
    // loading_button.style().set({shown: false});
    // waitPanel.widgets().reset([emptyMessage]);
  }
  
  var p1_heading = "Welcome! üëã";
  var p2_heading = "Welcome! üëã";
  var p3_heading = "Welcome! üëã";
  
  var p1_message = "Want to retrieve climate risk data \n\
  from space? This climate hazard tool enables\n\
  you to download and perform \n\
  further GIS analysis in no time!";
  
  var p2_message = "To begin with, select a country\n\
  and two data layers which you\n\
  would like to compare side to side.\n\
  Click start to compute and wait for a minute \n\
  for the layers to load on-the-fly.\n\
  Click layer label to view details\n\
  of the dataset, including the project website.";
  
  var p3_message = "Let's get started!";
  
  function addInstruction() {helper.addThreePage(
    p1_heading, p1_message,
    p2_heading, p2_message,
    p3_heading, p3_message,
    map1
    )}
  
  addInstruction();
};








